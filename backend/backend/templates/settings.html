{% extends "base.html" %}

{% block title %}Settings - Email Automation System{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Settings Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-gear me-2"></i>Settings
                </h2>
                <button class="btn btn-success" id="add-account-btn">
                    <i class="bi bi-plus-circle me-2"></i>Add Email Account
                </button>
            </div>
        </div>
    </div>

    <!-- Email Accounts Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-envelope-gear me-2"></i>Email Accounts
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" id="test-all-accounts-btn">
                        <i class="bi bi-wifi me-2"></i>Test All Connections
                    </button>
                </div>
                <div class="card-body">
                    <div id="accounts-list">
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-envelope-slash display-1 mb-3"></i>
                            <p>No email accounts configured. Click "Add Email Account" to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Add Email Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-account-form">
                    <div class="mb-3">
                        <label for="account-email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="account-email" required
                               placeholder="your-email@domain.com">
                    </div>
                    
                    <div class="mb-3">
                        <label for="account-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="account-password" required
                               placeholder="Your email password">
                        <div class="form-text">
                            Use app-specific password if you have 2FA enabled
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="imap-server" class="form-label">IMAP Server</label>
                        <input type="text" class="form-control" id="imap-server" required
                               placeholder="imap.hostinger.com" value="imap.hostinger.com">
                    </div>
                    
                    <div class="mb-3">
                        <label for="imap-port" class="form-label">IMAP Port</label>
                        <input type="number" class="form-control" id="imap-port" required
                               placeholder="993" value="993" min="1" max="65535">
                    </div>
                    
                    <div class="mb-3">
                        <label for="account-type" class="form-label">Account Type</label>
                        <select class="form-select" id="account-type">
                            <option value="hostinger" selected>Hostinger</option>
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="test-connection" checked>
                        <label class="form-check-label" for="test-connection">
                            Test connection before saving
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-account-btn">
                    <i class="bi bi-check-circle me-2"></i>Save Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>Edit Email Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-account-form">
                    <input type="hidden" id="edit-account-email">
                    
                    <div class="mb-3">
                        <label for="edit-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="edit-password"
                               placeholder="Leave empty to keep current password">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-imap-server" class="form-label">IMAP Server</label>
                        <input type="text" class="form-control" id="edit-imap-server" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-imap-port" class="form-label">IMAP Port</label>
                        <input type="number" class="form-control" id="edit-imap-port" required
                               min="1" max="65535">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit-is-active">
                        <label class="form-check-label" for="edit-is-active">
                            Account is active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="update-account-btn">
                    <i class="bi bi-check-circle me-2"></i>Update Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Email Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this email account?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will also delete all emails associated with this account.
                </div>
                <p><strong>Email:</strong> <span id="delete-account-email"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                    <i class="bi bi-trash me-2"></i>Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="toast-container"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    checkAuthAndRedirect();
    
    // Initialize settings page
    loadEmailAccounts();
    
    // Event listeners
    document.getElementById('add-account-btn').addEventListener('click', showAddAccountModal);
    document.getElementById('save-account-btn').addEventListener('click', saveEmailAccount);
    document.getElementById('update-account-btn').addEventListener('click', updateEmailAccount);
    document.getElementById('confirm-delete-btn').addEventListener('click', deleteEmailAccount);
    document.getElementById('test-all-accounts-btn').addEventListener('click', testAllAccounts);
    
    // Account type quick fill
    document.getElementById('account-type').addEventListener('change', function() {
        const serverField = document.getElementById('imap-server');
        const portField = document.getElementById('imap-port');
        
        switch(this.value) {
            case 'hostinger':
                serverField.value = 'imap.hostinger.com';
                portField.value = '993';
                break;
            case 'gmail':
                serverField.value = 'imap.gmail.com';
                portField.value = '993';
                break;
            case 'outlook':
                serverField.value = 'outlook.office365.com';
                portField.value = '993';
                break;
            default:
                serverField.value = '';
                portField.value = '993';
        }
    });
});

async function loadEmailAccounts() {
    try {
        const response = await fetchWithAuth('/api/settings/email-accounts');
        
        if (response.ok) {
            const data = await response.json();
            displayEmailAccounts(data.accounts);
        } else {
            showToast('Failed to load email accounts', 'error');
        }
    } catch (error) {
        console.error('Error loading email accounts:', error);
        showToast('Error loading email accounts', 'error');
    }
}

function displayEmailAccounts(accounts) {
    const accountsList = document.getElementById('accounts-list');
    
    if (accounts.length === 0) {
        accountsList.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-envelope-slash display-1 mb-3"></i>
                <p>No email accounts configured. Click "Add Email Account" to get started.</p>
            </div>
        `;
        return;
    }
    
    let accountsHTML = '';
    
    for (const account of accounts) {
        const statusBadge = account.is_active ? 
            '<span class="badge bg-success">Active</span>' : 
            '<span class="badge bg-secondary">Inactive</span>';
            
        const lastChecked = account.last_checked ? 
            new Date(account.last_checked).toLocaleDateString() : 'Never';
        
        accountsHTML += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="card-title mb-1">
                                <i class="bi bi-envelope me-2"></i>${account.email}
                            </h6>
                            <small class="text-muted">
                                ${account.imap_server}:${account.imap_port} (${account.account_type})
                            </small>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                ${statusBadge}
                                <br>
                                <small class="text-muted">Last checked: ${lastChecked}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="testConnection('${account.email}')">
                                    <i class="bi bi-wifi"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="editAccount('${account.email}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="showDeleteModal('${account.email}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    accountsList.innerHTML = accountsHTML;
}

function showAddAccountModal() {
    const modal = new bootstrap.Modal(document.getElementById('addAccountModal'));
    document.getElementById('add-account-form').reset();
    modal.show();
}

async function saveEmailAccount() {
    const btn = document.getElementById('save-account-btn');
    setLoadingState(btn, true);
    
    try {
        const formData = {
            email: document.getElementById('account-email').value.trim(),
            password: document.getElementById('account-password').value,
            imap_server: document.getElementById('imap-server').value.trim(),
            imap_port: parseInt(document.getElementById('imap-port').value),
            account_type: document.getElementById('account-type').value
        };
        
        if (!formData.email || !formData.password || !formData.imap_server) {
            showToast('Please fill in all required fields', 'error');
            setLoadingState(btn, false);
            return;
        }
        
        const response = await fetchWithAuth('/api/settings/email-accounts', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Email account added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
            loadEmailAccounts();
        } else {
            showToast(data.error || 'Failed to add email account', 'error');
        }
    } catch (error) {
        console.error('Error saving email account:', error);
        showToast('Error saving email account', 'error');
    } finally {
        setLoadingState(btn, false);
    }
}

async function testConnection(email) {
    try {
        showToast('Testing connection...', 'info');
        
        const response = await fetchWithAuth(`/api/settings/email-accounts/${encodeURIComponent(email)}/test`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.status === 'connected') {
                showToast(`Connection to ${email} successful!`, 'success');
            } else {
                showToast(`Connection to ${email} failed`, 'error');
            }
        } else {
            showToast(data.error || 'Failed to test connection', 'error');
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        showToast('Error testing connection', 'error');
    }
}

async function testAllAccounts() {
    const btn = document.getElementById('test-all-accounts-btn');
    setLoadingState(btn, true);
    
    try {
        showToast('Testing all account connections...', 'info');
        
        const response = await fetchWithAuth('/api/settings/email-accounts/test-all', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const results = data.test_results;
            const successful = data.successful;
            const total = data.total_tested;
            
            showToast(`Connection test complete: ${successful}/${total} accounts connected successfully`, 'info');
            
            // Show detailed results
            let resultsHTML = '<div class="mt-3"><h6>Test Results:</h6>';
            for (const result of results) {
                const statusIcon = result.status === 'connected' ? 
                    '<i class="bi bi-check-circle text-success"></i>' : 
                    '<i class="bi bi-x-circle text-danger"></i>';
                resultsHTML += `<div>${statusIcon} ${result.email}: ${result.status}</div>`;
            }
            resultsHTML += '</div>';
            
            // You could show this in a modal or update the accounts list
            loadEmailAccounts(); // Refresh the list
        } else {
            showToast(data.error || 'Failed to test accounts', 'error');
        }
    } catch (error) {
        console.error('Error testing accounts:', error);
        showToast('Error testing accounts', 'error');
    } finally {
        setLoadingState(btn, false);
    }
}

function editAccount(email) {
    // This would load the account details and show edit modal
    showToast('Edit functionality coming soon', 'info');
}

function showDeleteModal(email) {
    document.getElementById('delete-account-email').textContent = email;
    const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
    modal.show();
}

async function deleteEmailAccount() {
    const email = document.getElementById('delete-account-email').textContent;
    const btn = document.getElementById('confirm-delete-btn');
    setLoadingState(btn, true);
    
    try {
        const response = await fetchWithAuth(`/api/settings/email-accounts/${encodeURIComponent(email)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Email account deleted successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteAccountModal')).hide();
            loadEmailAccounts();
        } else {
            showToast(data.error || 'Failed to delete email account', 'error');
        }
    } catch (error) {
        console.error('Error deleting email account:', error);
        showToast('Error deleting email account', 'error');
    } finally {
        setLoadingState(btn, false);
    }
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Format date helper
function formatDateTime(date) {
    return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}
</script>
{% endblock %}