{% extends "base.html" %}

{% block title %}Reply to Email - Email Automation System{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Reply Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-reply me-2"></i>Reply to Email
                </h2>
                <button class="btn btn-secondary" onclick="history.back()">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Original Email -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-envelope me-2"></i>Original Email
                    </h6>
                </div>
                <div class="card-body">
                    <div id="original-email">
                        <div class="text-center py-4 text-muted">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading original email...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-pencil me-2"></i>Compose Reply
                    </h6>
                </div>
                <div class="card-body">
                    <form id="reply-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="from-account" class="form-label">From Account</label>
                                <select class="form-select" id="from-account" required>
                                    <option value="">Select email account...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="to-email" class="form-label">To</label>
                                <input type="email" class="form-control" id="to-email" required readonly>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cc-emails" class="form-label">CC (Optional)</label>
                                <input type="text" class="form-control" id="cc-emails" 
                                       placeholder="email1@example.com, email2@example.com">
                                <div class="form-text">Separate multiple emails with commas</div>
                            </div>
                            <div class="col-md-6">
                                <label for="bcc-emails" class="form-label">BCC (Optional)</label>
                                <input type="text" class="form-control" id="bcc-emails" 
                                       placeholder="email1@example.com, email2@example.com">
                                <div class="form-text">Separate multiple emails with commas</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reply-subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="reply-subject" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reply-body" class="form-label">Message</label>
                            <textarea class="form-control" id="reply-body" rows="12" required></textarea>
                        </div>
                        
                        <!-- Message Format Toggle -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="html-format">
                                <label class="form-check-label" for="html-format">
                                    Enable HTML formatting
                                </label>
                            </div>
                        </div>
                        
                        <!-- HTML Editor (hidden by default) -->
                        <div class="mb-3 d-none" id="html-editor-container">
                            <label for="reply-body-html" class="form-label">HTML Message</label>
                            <textarea class="form-control" id="reply-body-html" rows="8"></textarea>
                            <div class="form-text">You can use basic HTML tags for formatting</div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-primary" id="save-draft-btn">
                                    <i class="bi bi-save me-2"></i>Save Draft
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="preview-btn">
                                    <i class="bi bi-eye me-2"></i>Preview
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="history.back()">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" id="send-reply-btn">
                                    <i class="bi bi-send me-2"></i>Send Reply
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye me-2"></i>Email Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="email-preview">
                    <!-- Preview content will be injected here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="document.getElementById('send-reply-btn').click()">
                    <i class="bi bi-send me-2"></i>Send Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send Confirmation Modal -->
<div class="modal fade" id="sendConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle me-2"></i>Email Sent Successfully
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
                    <h5>Your reply has been sent successfully!</h5>
                    <div id="send-details" class="mt-3">
                        <!-- Send details will be injected here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.location.href='/dashboard'">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    checkAuthAndRedirect();
    
    // Get email ID from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const emailId = urlParams.get('email_id');
    
    if (!emailId) {
        showToast('No email ID provided', 'error');
        window.location.href = '/dashboard';
        return;
    }
    
    // Load original email and reply template
    loadOriginalEmail(emailId);
    loadReplyAccounts();
    
    // Event listeners
    document.getElementById('reply-form').addEventListener('submit', sendReply);
    document.getElementById('preview-btn').addEventListener('click', showPreview);
    document.getElementById('save-draft-btn').addEventListener('click', saveDraft);
    document.getElementById('html-format').addEventListener('change', toggleHtmlEditor);
});

async function loadOriginalEmail(emailId) {
    try {
        // Load original email
        const emailResponse = await fetchWithAuth(`/api/emails/${emailId}`);
        if (!emailResponse.ok) {
            throw new Error('Failed to load original email');
        }
        
        const emailData = await emailResponse.json();
        displayOriginalEmail(emailData.email);
        
        // Load reply template
        const templateResponse = await fetchWithAuth(`/api/replies/template/${emailId}`);
        if (templateResponse.ok) {
            const templateData = await templateResponse.json();
            populateReplyForm(templateData.template);
        }
        
    } catch (error) {
        console.error('Error loading original email:', error);
        showToast('Failed to load email details', 'error');
        document.getElementById('original-email').innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-triangle display-1 mb-3"></i>
                <p>Failed to load original email</p>
            </div>
        `;
    }
}

function displayOriginalEmail(email) {
    const container = document.getElementById('original-email');
    
    const emailHTML = `
        <div class="border rounded p-3" style="background-color: var(--bs-light);">
            <div class="row mb-2">
                <div class="col-sm-2"><strong>From:</strong></div>
                <div class="col-sm-10">${escapeHtml(email.sender)}</div>
            </div>
            <div class="row mb-2">
                <div class="col-sm-2"><strong>To:</strong></div>
                <div class="col-sm-10">${escapeHtml(email.account_email)}</div>
            </div>
            <div class="row mb-2">
                <div class="col-sm-2"><strong>Subject:</strong></div>
                <div class="col-sm-10">${escapeHtml(email.subject)}</div>
            </div>
            <div class="row mb-2">
                <div class="col-sm-2"><strong>Date:</strong></div>
                <div class="col-sm-10">${formatDateTime(new Date(email.date))}</div>
            </div>
            <div class="row mb-2">
                <div class="col-sm-2"><strong>Category:</strong></div>
                <div class="col-sm-10">
                    <span class="badge bg-secondary">${escapeHtml(email.category)}</span>
                </div>
            </div>
            <hr>
            <div style="max-height: 300px; overflow-y: auto;">
                <pre style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(email.body)}</pre>
            </div>
        </div>
    `;
    
    container.innerHTML = emailHTML;
}

function populateReplyForm(template) {
    document.getElementById('to-email').value = template.to_email || '';
    document.getElementById('reply-subject').value = template.subject || '';
    document.getElementById('reply-body').value = template.body || '';
    
    // Store reply-to ID for threading
    document.getElementById('reply-form').dataset.replyToId = template.reply_to_id || '';
}

async function loadReplyAccounts() {
    try {
        const response = await fetchWithAuth('/api/replies/accounts');
        if (!response.ok) {
            throw new Error('Failed to load accounts');
        }
        
        const data = await response.json();
        const accountSelect = document.getElementById('from-account');
        
        accountSelect.innerHTML = '<option value="">Select email account...</option>';
        
        for (const account of data.accounts) {
            const option = document.createElement('option');
            option.value = account.email;
            option.textContent = `${account.email} (${account.account_type})`;
            accountSelect.appendChild(option);
        }
        
    } catch (error) {
        console.error('Error loading reply accounts:', error);
        showToast('Failed to load email accounts', 'error');
    }
}

async function sendReply(event) {
    event.preventDefault();
    
    const btn = document.getElementById('send-reply-btn');
    setLoadingState(btn, true);
    
    try {
        const formData = {
            account_email: document.getElementById('from-account').value,
            to_email: document.getElementById('to-email').value,
            subject: document.getElementById('reply-subject').value,
            body: document.getElementById('reply-body').value,
            reply_to_id: document.getElementById('reply-form').dataset.replyToId
        };
        
        // Add CC and BCC if provided
        const ccValue = document.getElementById('cc-emails').value.trim();
        const bccValue = document.getElementById('bcc-emails').value.trim();
        
        if (ccValue) {
            formData.cc = ccValue.split(',').map(email => email.trim()).filter(email => email);
        }
        
        if (bccValue) {
            formData.bcc = bccValue.split(',').map(email => email.trim()).filter(email => email);
        }
        
        // Add HTML content if enabled
        if (document.getElementById('html-format').checked) {
            formData.body_html = document.getElementById('reply-body-html').value;
        }
        
        // Validate form
        if (!formData.account_email || !formData.to_email || !formData.subject || !formData.body) {
            showToast('Please fill in all required fields', 'error');
            setLoadingState(btn, false);
            return;
        }
        
        const response = await fetchWithAuth('/api/replies/compose', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSendConfirmation(data);
        } else {
            showToast(data.error || 'Failed to send reply', 'error');
        }
        
    } catch (error) {
        console.error('Error sending reply:', error);
        showToast('Error sending reply', 'error');
    } finally {
        setLoadingState(btn, false);
    }
}

function showSendConfirmation(data) {
    const detailsContainer = document.getElementById('send-details');
    detailsContainer.innerHTML = `
        <div class="text-start">
            <p><strong>From:</strong> ${escapeHtml(data.from)}</p>
            <p><strong>To:</strong> ${escapeHtml(data.to)}</p>
            <p><strong>Subject:</strong> ${escapeHtml(data.subject)}</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('sendConfirmModal'));
    modal.show();
}

function showPreview() {
    const subject = document.getElementById('reply-subject').value;
    const body = document.getElementById('reply-body').value;
    const htmlBody = document.getElementById('reply-body-html').value;
    const isHtml = document.getElementById('html-format').checked;
    
    let previewContent = `
        <div class="border rounded p-3">
            <div class="row mb-2">
                <div class="col-sm-2"><strong>Subject:</strong></div>
                <div class="col-sm-10">${escapeHtml(subject)}</div>
            </div>
            <hr>
            <div>
    `;
    
    if (isHtml && htmlBody) {
        previewContent += htmlBody;
    } else {
        previewContent += `<pre style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(body)}</pre>`;
    }
    
    previewContent += `
            </div>
        </div>
    `;
    
    document.getElementById('email-preview').innerHTML = previewContent;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

function toggleHtmlEditor() {
    const isChecked = document.getElementById('html-format').checked;
    const htmlContainer = document.getElementById('html-editor-container');
    
    if (isChecked) {
        htmlContainer.classList.remove('d-none');
        // Copy plain text to HTML editor if it's empty
        const htmlEditor = document.getElementById('reply-body-html');
        if (!htmlEditor.value) {
            const plainText = document.getElementById('reply-body').value;
            htmlEditor.value = plainText.replace(/\n/g, '<br>');
        }
    } else {
        htmlContainer.classList.add('d-none');
    }
}

function saveDraft() {
    // Placeholder for draft saving functionality
    showToast('Draft saved locally (full draft saving coming soon)', 'info');
    
    // Store draft in localStorage as a simple implementation
    const draft = {
        from_account: document.getElementById('from-account').value,
        to_email: document.getElementById('to-email').value,
        subject: document.getElementById('reply-subject').value,
        body: document.getElementById('reply-body').value,
        cc: document.getElementById('cc-emails').value,
        bcc: document.getElementById('bcc-emails').value,
        html_format: document.getElementById('html-format').checked,
        body_html: document.getElementById('reply-body-html').value,
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('email_draft', JSON.stringify(draft));
}

// Load draft on page load if available
function loadDraft() {
    const draftData = localStorage.getItem('email_draft');
    if (draftData) {
        try {
            const draft = JSON.parse(draftData);
            
            // Only load if it's recent (within 24 hours)
            const draftTime = new Date(draft.timestamp);
            const now = new Date();
            const hoursDiff = (now - draftTime) / (1000 * 60 * 60);
            
            if (hoursDiff < 24) {
                if (confirm('A recent draft was found. Would you like to load it?')) {
                    document.getElementById('from-account').value = draft.from_account || '';
                    document.getElementById('reply-subject').value = draft.subject || '';
                    document.getElementById('reply-body').value = draft.body || '';
                    document.getElementById('cc-emails').value = draft.cc || '';
                    document.getElementById('bcc-emails').value = draft.bcc || '';
                    document.getElementById('html-format').checked = draft.html_format || false;
                    document.getElementById('reply-body-html').value = draft.body_html || '';
                    
                    if (draft.html_format) {
                        toggleHtmlEditor();
                    }
                }
            }
        } catch (error) {
            console.error('Error loading draft:', error);
        }
    }
}

// Load draft after page loads
setTimeout(loadDraft, 1000);
</script>
{% endblock %}